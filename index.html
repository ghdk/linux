<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Operating System</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="None" href="index.html#document-index" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="operating-system">
<h1>Operating System<a class="headerlink" href="#operating-system" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<span id="document-Introduction"></span><div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Operating system is a fork of the Linux kernel version 3.19. The aim of this
project is to study computer architecture and provide documentation that
covers the areas of study. Such a study requires a kernel. At first I started
writing my own kernel, but soon I found myself using snippets from my own
code in the documentation. In order to bring greater value to the reader, I
decided to use instead the code base of a kernel with real world application.
Hence, this fork was born.</p>
<p>For offline access to this material you can download the
<a class="reference download internal" href="_downloads/os.pdf"><tt class="xref download docutils literal"><span class="pre">PDF</span></tt></a> version. The repository of this
project is hosted on <a class="reference external" href="https://github.com/ghdk/os">GitHub</a>.</p>
</div>
<span id="document-Toolchain"></span><div class="section" id="toolchain">
<h2>Toolchain<a class="headerlink" href="#toolchain" title="Permalink to this headline">¶</a></h2>
<div class="section" id="building-a-cross-compiler">
<h3>Building a cross-compiler<a class="headerlink" href="#building-a-cross-compiler" title="Permalink to this headline">¶</a></h3>
<p>Since I will be building my OS on Linux it is a good idea to prepare and use
a cross compiler. On OSDev wiki there is a very nice
<a class="reference external" href="http://wiki.osdev.org/Why_do_I_need_a_Cross_Compiler%3F">article</a> on the
subject. Moreover, on OSDev wiki there is a
<a class="reference external" href="http://wiki.osdev.org/GCC_Cross-Compiler">tutorial</a> on how to prepare a
toolchain for cross compiling an OS. Here I assume you have read the OSDev wiki
pages.</p>
<p>First I set a few environmental variables</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">~ # export TARGET=i686-elf</span>

<span class="go">~ # mkdir -p ${HOME}/Applications/cross-i686/bin</span>
<span class="go">~ # export PREFIX=&quot;${HOME}/Applications/cross-i686&quot;</span>
<span class="go">~ # export PATH=&quot;${PREFIX}/bin:${PATH}&quot;</span>
</pre></div>
</td></tr></table></div>
<p>Before building GCC, I built binutils
(see <a class="reference external" href="https://gnu.org/software/binutils/">https://gnu.org/software/binutils/</a>)</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">~ # wget http://ftp.gnu.org/gnu/binutils/binutils-2.26.tar.bz2</span>
<span class="go">~ # tar xvfj binutils-2.26.tar.bz2</span>
<span class="go">~ # mkdir binutils-2.26-build</span>
<span class="go">~ # cd binutils-2.26-build</span>
<span class="go">binutils-2.26-build # ../binutils-2.26/configure --target=${TARGET}</span>
<span class="go">                                                 --prefix=${PREFIX}</span>
<span class="go">                                                 --with-sysroot</span>
<span class="go">                                                 --disable-nls</span>
<span class="go">                                                 --disable-werror</span>
<span class="go">binutils-2.26-build # make &amp;&amp; make install</span>
</pre></div>
</td></tr></table></div>
<p>It is advisable that when we build a GCC cross compiler to build a version that
is close to the version of the GCC compiler we use to compile. My laptop has</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">~ # gcc --version</span>
<span class="go">gcc (Debian 4.9.2-10) 4.9.2</span>
</pre></div>
</td></tr></table></div>
<p>so I downloaded a version based on the 4.9.x release (see
<a class="reference external" href="https://gcc.gnu.org/">https://gcc.gnu.org/</a></p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">~ # wget http://www.netgull.com/gcc/releases/gcc-4.9.3/gcc-4.9.3.tar.gz</span>
</pre></div>
</td></tr></table></div>
<p>As advised on the OSDev wiki, I also downloaded the GNU GMP, GNU MPFR, GNU MPC
and the ISL library</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">gcc-4.9.3 # ./contrib/download_prerequisites</span>
</pre></div>
</td></tr></table></div>
<p>However, the script that came with GCC did not work for me. This is the patch
i applied:</p>
<div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span class="gd">--- contrib/download_prerequisites   2014-02-13 14:06:48.000000000 +0000</span>
<span class="gi">+++ download_prerequisites   2016-07-02 14:25:57.444427985 +0100</span>
<span class="gu">@@ -29,15 +29,17 @@</span>
 GMP=gmp-4.3.2
 MPC=mpc-0.8.1

<span class="gd">-wget ftp://gcc.gnu.org/pub/gcc/infrastructure/$MPFR.tar.bz2 || exit 1</span>
<span class="gi">+URL=&#39;http://ftp.vim.org/languages/gcc/infrastructure&#39;</span>
<span class="gi">+</span>
<span class="gi">+wget ${URL}/$MPFR.tar.bz2 || exit 1</span>
 tar xjf $MPFR.tar.bz2 || exit 1
 ln -sf $MPFR mpfr || exit 1

<span class="gd">-wget ftp://gcc.gnu.org/pub/gcc/infrastructure/$GMP.tar.bz2 || exit 1</span>
<span class="gi">+wget ${URL}/$GMP.tar.bz2 || exit 1</span>
 tar xjf $GMP.tar.bz2  || exit 1
 ln -sf $GMP gmp || exit 1

<span class="gd">-wget ftp://gcc.gnu.org/pub/gcc/infrastructure/$MPC.tar.gz || exit 1</span>
<span class="gi">+wget ${URL}/$MPC.tar.gz || exit 1</span>
 tar xzf $MPC.tar.gz || exit 1
 ln -sf $MPC mpc || exit 1

<span class="gu">@@ -46,11 +48,11 @@</span>
   ISL=isl-0.12.2
   CLOOG=cloog-0.18.1

<span class="gd">-  wget ftp://gcc.gnu.org/pub/gcc/infrastructure/$ISL.tar.bz2 || exit 1</span>
<span class="gi">+  wget ${URL}/$ISL.tar.bz2 || exit 1</span>
   tar xjf $ISL.tar.bz2  || exit 1
   ln -sf $ISL isl || exit 1

<span class="gd">-  wget ftp://gcc.gnu.org/pub/gcc/infrastructure/$CLOOG.tar.gz || exit 1</span>
<span class="gi">+  wget ${URL}/$CLOOG.tar.gz || exit 1</span>
   tar xzf $CLOOG.tar.gz || exit 1
   ln -sf $CLOOG cloog || exit 1
 fi
</pre></div>
</td></tr></table></div>
<p>Finally I compiled GCC</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">~ # mkdir gcc-4.9.3-build</span>
<span class="go">~ # cd gcc-4.9.3-build</span>
<span class="go">gcc-4.9.3-build # ../gcc-4.9.3/configure --target=${TARGET}</span>
<span class="go">                                         --prefix=${PREFIX}</span>
<span class="go">                                         --disable-nls</span>
<span class="go">                                         --enable-languages=c,c++</span>
<span class="go">                                         --without-headers</span>
<span class="go">gcc-4.9.3-build # make all-gcc</span>
<span class="go">gcc-4.9.3-build # make all-target-libgcc</span>
<span class="go">gcc-4.9.3-build # make install-gcc</span>
<span class="go">gcc-4.9.3-build # make install-target-libgcc</span>
</pre></div>
</td></tr></table></div>
<p>I wanted also to prepare a cross compiler for x86_64 so I set the following
environmental variables and repeated the previous steps</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">~ # export TARGET=x86_64-elf</span>

<span class="go">~ # mkdir -p ${HOME}/Applications/cross-x86_64/bin</span>
<span class="go">~ # export PREFIX=&quot;$HOME/Applications/cross-x86_64&quot;</span>
<span class="go">~ # export PATH=&quot;$PREFIX/bin:$PATH&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="building-grub">
<h3>Building GRUB<a class="headerlink" href="#building-grub" title="Permalink to this headline">¶</a></h3>
<p>Instructions for downloading GRUB can be found on the GRUB 2
<a class="reference external" href="https://www.gnu.org/software/grub/grub-download.html">website</a>. I cloned
the GRUB repository:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> git clone git://git.savannah.gnu.org/grub.git
</pre></div>
</td></tr></table></div>
<p>In the root directory there is an INSTALL file with instructions for compiling
GRUB. I compiled GRUB through the following steps:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> ./autogen.sh
<span class="gp">#</span> ./configure
<span class="gp">#</span> make install
</pre></div>
</td></tr></table></div>
<p>From the installation of GRUB we are interested in grub-mkrescue which we will
be using for preparing bootable ISOs, and the lib directory which contains
the modules:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> find ./grub2 -iwholename <span class="s1">&#39;*mkrescue&#39;</span> -o -iwholename <span class="s1">&#39;*lib/grub/*&#39;</span> -prune
<span class="go">./grub2/lib/grub/i386-pc</span>
<span class="go">./grub2/bin/grub-mkrescue</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="building-linux">
<h3>Building Linux<a class="headerlink" href="#building-linux" title="Permalink to this headline">¶</a></h3>
<p>Linux uses the kbuild framework. We can obtain the list of targets by running</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> make <span class="nb">help</span>
</pre></div>
</td></tr></table></div>
<p>We can specify a build directory in the following fashion</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> make <span class="nv">O</span><span class="o">=</span>_build <span class="nv">ARCH</span><span class="o">=</span><span class="s2">&quot;x86&quot;</span> tinyconfig
</pre></div>
</td></tr></table></div>
<p>In this example the build directory is &#8216;_build&#8217; and I made the tinyconfig
target, which configures the tiniest possible kernel. An alternative method of
configuring the kernel easily would be to use the default configuration</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> make <span class="nv">O</span><span class="o">=</span>_build <span class="nv">ARCH</span><span class="o">=</span><span class="s2">&quot;x86&quot;</span> defconfig
</pre></div>
</td></tr></table></div>
<p>Having a minimal or default configuration we can run menuconfig to
tweak it</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> make <span class="nv">O</span><span class="o">=</span>_build <span class="nv">ARCH</span><span class="o">=</span><span class="s2">&quot;x86&quot;</span> menuconfig
</pre></div>
</td></tr></table></div>
<p>Once we are happy with the configuration, we can build the kernel. For the x86
architecture I usually make the isoimage target which creates a bootable iso</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> make <span class="nv">O</span><span class="o">=</span>_build -j2 isoimage
</pre></div>
</td></tr></table></div>
<p>The original isoimage target uses the
<a class="reference external" href="http://www.syslinux.org/wiki/index.php?title=ISOLINUX">isolinux</a> boot loader.
I replaced isolinux with GRUB, as GRUB is the bootloader that most probably the
reader is familiar with. GRUB provides the command grub-mkrescue which
builds an ISO image:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> grub-mkrescue -d ./grub2/lib/grub/i386-pc -o live.iso isoimage
</pre></div>
</td></tr></table></div>
<p>This command is given the directory where the GRUB modules live. We can set
this by running make menuconfig as shown above, and navigating into
Operating System &gt; &#8220;GRUB modules path&#8221;. When I ran grub-mkrescue for the first
time, I got an error message that it could not locate xorriso</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">grub-mkrescue: 323: xorriso: not found</span>
</pre></div>
</td></tr></table></div>
<p>so i had to install the xorriso library. Then xorriso complained that it
could not find the efi.img file</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">xorriso : FAILURE : Cannot find path &#39;/efi.img&#39; in loaded ISO image</span>
</pre></div>
</td></tr></table></div>
<p>so I had to install the mtools package.</p>
<p>The last argument to this command is a directory that will be included in the
ISO. GRUB expects a specific structure</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> find isoimage
<span class="go">isoimage/</span>
<span class="go">isoimage/boot</span>
<span class="go">isoimage/boot/grub</span>
<span class="go">isoimage/boot/grub/grub.cfg</span>
<span class="go">isoimage/boot/bzImage</span>
</pre></div>
</td></tr></table></div>
<p>Our kernel is the file &#8220;bzImage&#8221;. The GRUB configuration file contains</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> cat isoimage/boot/grub/grub.cfg
<span class="go">menuentry &quot;Linux&quot; {</span>
<span class="go">   linux /boot/bzImage</span>
<span class="go">   boot</span>
<span class="go">}</span>
</pre></div>
</td></tr></table></div>
<p>Make sure the open brace is at the same line as the menuentry definition.</p>
<p>As part of this project we are customising the Linux build system so that it
can build our additions. Previously we mentioned the menu
Operating System &gt; &#8220;GRUB modules path&#8221; where we can declare the path where the
GRUB modules live. The menu Device Drivers &gt; Operating System lists the modules
that we have added and that we can compile as part of Linux.</p>
</div>
<div class="section" id="building-linux-modules">
<h3>Building Linux modules<a class="headerlink" href="#building-linux-modules" title="Permalink to this headline">¶</a></h3>
<p>An example module is drivers/os/modapi.c, whose contents are not particularly
interesting at this point. However, it can serve as an example of how a module
can be compiled.</p>
<p>We can run make menuconfig, go to Device Drivers &gt; Operating System and set the
&#8220;Poke the Module API&#8221; to &#8220;M&#8221;. &#8220;M&#8221; means that the module will be built for
dynamic loading, while &#8220;*&#8221; means that the module will be statically linked
against our kernel. Having done so, we can compile all activated modules,
against our source tree with the command:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">make O=_build ARCH=&quot;x86&quot; -j4 modules</span>
</pre></div>
</td></tr></table></div>
<p>The following command does all the above, plus it compiles our module against
the sources of an installed kernel:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">make -C /lib/modules/3.16.0-4-586/build M=${PWD}/drivers/os CONFIG_OS_MODAPI_C=m modules</span>
</pre></div>
</td></tr></table></div>
<p>Having compiled our module we can copy it to a VM running the corresponding
kernel and try it out:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> mkdir -p /lib/modules/3.16.0-4-586/extra
<span class="gp">#</span> mv /tmp/modapi.ko /lib/modules/3.16.0-4-586/extra/
<span class="gp">#</span> depmod /lib/modules/3.16.0-4-586/extra/modapi.ko
<span class="gp">#</span> modprobe modapi
<span class="gp">#</span> lsmod <span class="p">|</span>grep modapi
<span class="go">modapi                 12386  0</span>
<span class="gp">#</span> modprobe -r modapi
<span class="gp">#</span> tail -n <span class="m">2</span> /var/log/messages
<span class="go">Nov 19 17:42:26 vbdeb kernel: [ 2198.076194] modapi.c: 28: mod_init</span>
<span class="go">Nov 19 17:42:40 vbdeb kernel: [ 2211.619753] modapi.c: 36: mod_exit</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="debugging-with-a-vm">
<h3>Debugging with a VM<a class="headerlink" href="#debugging-with-a-vm" title="Permalink to this headline">¶</a></h3>
<p>During development I will be using a virtual machine for debugging. One solution
is <a class="reference external" href="http://wiki.qemu.org/Main_Page">QEMU</a> which has support for
<a class="reference external" href="http://wiki.qemu.org/Documentation/Debugging">GDB</a> as well as
<a class="reference external" href="http://wiki.qemu.org/Debugging_with_Valgrind">Valgrind</a>. An alternative is
<a class="reference external" href="http://www.virtualbox.org/">VirtualBox</a> which has a built in
<a class="reference external" href="http://www.virtualbox.org/manual/ch12.html#ts_debugger">debugger</a>.
Unfortunately on VirtualBox breakpoints do not work when hardware virtualisation
is enabled, which is a requirement for a 64bit VM. The
following is an example of a VirtualBox VM configuration with which debugging
can be used:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> VBoxManage showvminfo <span class="s2">&quot;OS&quot;</span>
<span class="go">[...]</span>
<span class="go">Guest OS:        Other/Unknown</span>
<span class="go">[...]</span>
<span class="go">Memory size:     16MB</span>
<span class="go">Page Fusion:     off</span>
<span class="go">VRAM size:       16MB</span>
<span class="go">CPU exec cap:    20%</span>
<span class="go">HPET:            off</span>
<span class="go">Chipset:         ich9</span>
<span class="go">Firmware:        BIOS</span>
<span class="go">Number of CPUs:  1</span>
<span class="go">PAE:             off</span>
<span class="go">Long Mode:       off</span>
<span class="go">Synthetic CPU:   off</span>
<span class="go">CPUID overrides: None</span>
<span class="go">Boot menu mode:  message and menu</span>
<span class="go">Boot Device (1): DVD</span>
<span class="go">Boot Device (2): HardDisk</span>
<span class="go">Boot Device (3): Not Assigned</span>
<span class="go">Boot Device (4): Not Assigned</span>
<span class="go">ACPI:            on</span>
<span class="go">IOAPIC:          on</span>
<span class="go">Time offset:     0ms</span>
<span class="go">RTC:             UTC</span>
<span class="go">Hardw. virt.ext: off</span>
<span class="go">Nested Paging:   off</span>
<span class="go">Large Pages:     off</span>
<span class="go">VT-x VPID:       on</span>
<span class="go">VT-x unr. exec.: on</span>
<span class="go">[...]</span>
</pre></div>
</td></tr></table></div>
<p>To enable the debug menu by default we need to set the GUI/Dbg/Enabled property
of the VM:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> VBoxManage setextradata <span class="s2">&quot;OS&quot;</span> <span class="s1">&#39;GUI/Dbg/Enabled&#39;</span> <span class="nb">true</span>
<span class="gp">#</span><span class="nb"> </span>VBoxManage getextradata <span class="s2">&quot;OS&quot;</span> <span class="s1">&#39;GUI/Dbg/Enabled&#39;</span>
<span class="go">Value: true</span>
</pre></div>
</td></tr></table></div>
<p>From the debug menu we can launch the console, through which we can set
breakpoints, step through instructions, display the registers and many more.
For example let us suppose we have a kernel with the following main function
at address 0x0010200b:</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre>0010200b &lt;main&gt;:
  10200b:       55                      push   %ebp
  10200c:       89 e5                   mov    %esp,%ebp
  10200e:       b8 ef be ad de          mov    $0xdeadbeef,%eax
  102013:       5d                      pop    %ebp
  102014:       c3                      ret
</pre></div>
</td></tr></table></div>
<p>We can set a breakpoint in the VirtualBox console to break the execution at our
main function:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>VBoxDbg&gt; br 0010200b 1 &#39;echo main&#39;
Set REM breakpoint 4 at 000000000010200b
</pre></div>
</td></tr></table></div>
<p>When the breakpoint is reached the console shows:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre>VBoxDbg&gt; main
eax=2badb002 ebx=00010000 ecx=00000000 edx=00000000 esi=00000000 edi=00000000
eip=0010200b esp=0007fefc ebp=00000000 iopl=0 nv up di pl nz na po nc
cs=0010 ds=0018 es=0018 fs=0018 gs=0018 ss=0018               eflags=00000006
0010:0010200b 55                      push ebp
</pre></div>
</td></tr></table></div>
<p>We can press &#8216;t&#8217; to do a single step:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre>VBoxDbg&gt; t
VBoxDbg&gt;
dbgf event: Single step! (rem)
eax=2badb002 ebx=00010000 ecx=00000000 edx=00000000 esi=00000000 edi=00000000
eip=0010200c esp=0007fef8 ebp=00000000 iopl=0 nv up di pl nz na po nc
cs=0010 ds=0018 es=0018 fs=0018 gs=0018 ss=0018               eflags=00000006
0010:0010200c 89 e5                   mov ebp, esp
VBoxDbg&gt; t
VBoxDbg&gt;
dbgf event: Single step! (rem)
eax=2badb002 ebx=00010000 ecx=00000000 edx=00000000 esi=00000000 edi=00000000
eip=0010200e esp=0007fef8 ebp=0007fef8 iopl=0 nv up di pl nz na po nc
cs=0010 ds=0018 es=0018 fs=0018 gs=0018 ss=0018               eflags=00000006
0010:0010200e b8 ef be ad de          mov eax, 0deadbeefh
VBoxDbg&gt; t
VBoxDbg&gt;
dbgf event: Single step! (rem)
eax=deadbeef ebx=00010000 ecx=00000000 edx=00000000 esi=00000000 edi=00000000
eip=00102013 esp=0007fef8 ebp=0007fef8 iopl=0 nv up di pl nz na po nc
cs=0010 ds=0018 es=0018 fs=0018 gs=0018 ss=0018               eflags=00000006
0010:00102013 5d                      pop ebp
</pre></div>
</td></tr></table></div>
<p>We can display the registers with &#8216;r&#8217;:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre>VBoxDbg&gt; r
eax=deadbeef ebx=00010000 ecx=00000000 edx=00000000 esi=00000000 edi=00000000
eip=00102013 esp=0007fef8 ebp=0007fef8 iopl=0 nv up di pl nz na po nc
cs=0010 ds=0018 es=0018 fs=0018 gs=0018 ss=0018               eflags=00000006
0010:00102013 5d                      pop ebp
</pre></div>
</td></tr></table></div>
</div>
</div>
<span id="document-ProgramLoading"></span><div class="section" id="program-loading">
<h2>Program loading<a class="headerlink" href="#program-loading" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>Let us start the discussion by writing a hello world program</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Using the compiler of our distribution we can build this program as expected</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> gcc main.c
<span class="gp">#</span> ./a.out
<span class="go">Hello world!</span>
</pre></div>
</td></tr></table></div>
<p>However, if we try to build the same program with our cross compilers we get</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-gcc main.c
<span class="go">main.c:1:19: fatal error: stdio.h: No such file or directory</span>
<span class="gp">#</span>include &lt;stdio.h&gt;
<span class="go">                  ^</span>
<span class="go">compilation terminated.</span>
</pre></div>
</td></tr></table></div>
<p>Many parts of the C standard library rely on having an operating system. Since
we are writing an operating system, we get only a small subset of the C
standard library, which can be found in the include subdirectory of our
cross compiler.</p>
<p>If we strip away all the code that relies on the standard library we end up</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>If we try to compile this, we get</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-gcc main.c -nostdlib -ffreestanding
<span class="go">ld: warning: cannot find entry symbol _start; defaulting to 08048054</span>
</pre></div>
</td></tr></table></div>
<p>This says that we do not have a C runtime either. Since our cross compiler is
built without targeting a specific OS, it does not know which loader will be
used to execute our program.</p>
</div>
<div class="section" id="elf-executable-and-linking-format">
<h3>ELF: Executable and Linking Format<a class="headerlink" href="#elf-executable-and-linking-format" title="Permalink to this headline">¶</a></h3>
<p>Before we discuss in detail the C runtime, and how a program is loaded for
execution, we need to have a look at the
<a class="reference external" href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ELF</a> format. <a class="reference external" href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ELF</a> is
the format we chose for our kernel executable, by building our cross-compilers
with the target</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">~ # export TARGET=i686-elf</span>
</pre></div>
</td></tr></table></div>
<p>Let us compile and study the executable of the program</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> gcc main.c
<span class="gp">#</span> readelf -a a.out
<span class="go">ELF Header:</span>
<span class="go">  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00</span>
<span class="go">  Class:                             ELF32</span>
<span class="go">  Data:                              2&#39;s complement, little endian</span>
<span class="go">  Version:                           1 (current)</span>
<span class="go">  OS/ABI:                            UNIX - System V</span>
<span class="go">  ABI Version:                       0</span>
<span class="go">  Type:                              EXEC (Executable file)</span>
<span class="go">  Machine:                           Intel 80386</span>
<span class="go">  Version:                           0x1</span>
<span class="go">  Entry point address:               0x80482d0</span>
<span class="go">  Start of program headers:          52 (bytes into file)</span>
<span class="go">  Start of section headers:          3584 (bytes into file)</span>
<span class="go">  Flags:                             0x0</span>
<span class="go">  Size of this header:               52 (bytes)</span>
<span class="go">  Size of program headers:           32 (bytes)</span>
<span class="go">  Number of program headers:         8</span>
<span class="go">  Size of section headers:           40 (bytes)</span>
<span class="go">  Number of section headers:         30</span>
<span class="go">  Section header string table index: 27</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Magic:</th><td class="field-body">The first four bytes of the file hold a magic number identifying the
file as an <a class="reference external" href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ELF</a> object file, ie. 0x7f, 0x45 = E, 0x4c = L, 0x46 = F.</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Entry point address:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body">The address of the _start function of the program. This is the first function
that is being run during program execution. In the next chapter we discuss it
in detail.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Flags:</th><td class="field-body">Flags associated with the file. For 32 bit files this is always zero.</td>
</tr>
</tbody>
</table>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">Section Headers:</span>
<span class="go">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span>
<span class="go">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span>
<span class="go">  [ 1] .interp           PROGBITS        08048134 000134 000013 00   A  0   0  1</span>
<span class="go">  [ 2] .note.ABI-tag     NOTE            08048148 000148 000020 00   A  0   0  4</span>
<span class="go">  [ 3] .note.gnu.build-i NOTE            08048168 000168 000024 00   A  0   0  4</span>
<span class="go">  [ 4] .gnu.hash         GNU_HASH        0804818c 00018c 000020 04   A  5   0  4</span>
<span class="go">  [ 5] .dynsym           DYNSYM          080481ac 0001ac 000040 10   A  6   1  4</span>
<span class="go">  [ 6] .dynstr           STRTAB          080481ec 0001ec 000045 00   A  0   0  1</span>
<span class="go">  [ 7] .gnu.version      VERSYM          08048232 000232 000008 02   A  5   0  2</span>
<span class="go">  [ 8] .gnu.version_r    VERNEED         0804823c 00023c 000020 00   A  6   1  4</span>
<span class="go">  [ 9] .rel.dyn          REL             0804825c 00025c 000008 08   A  5   0  4</span>
<span class="go">  [10] .rel.plt          REL             08048264 000264 000010 08  AI  5  12  4</span>
<span class="go">  [11] .init             PROGBITS        08048274 000274 000023 00  AX  0   0  4</span>
<span class="go">  [12] .plt              PROGBITS        080482a0 0002a0 000030 04  AX  0   0 16</span>
<span class="go">  [13] .text             PROGBITS        080482d0 0002d0 000182 00  AX  0   0 16</span>
<span class="go">  [14] .fini             PROGBITS        08048454 000454 000014 00  AX  0   0  4</span>
<span class="go">  [15] .rodata           PROGBITS        08048468 000468 000008 00   A  0   0  4</span>
<span class="go">  [16] .eh_frame_hdr     PROGBITS        08048470 000470 00002c 00   A  0   0  4</span>
<span class="go">  [17] .eh_frame         PROGBITS        0804849c 00049c 0000b0 00   A  0   0  4</span>
<span class="go">  [18] .init_array       INIT_ARRAY      0804954c 00054c 000004 00  WA  0   0  4</span>
<span class="go">  [19] .fini_array       FINI_ARRAY      08049550 000550 000004 00  WA  0   0  4</span>
<span class="go">  [20] .jcr              PROGBITS        08049554 000554 000004 00  WA  0   0  4</span>
<span class="go">  [21] .dynamic          DYNAMIC         08049558 000558 0000e8 08  WA  6   0  4</span>
<span class="go">  [22] .got              PROGBITS        08049640 000640 000004 04  WA  0   0  4</span>
<span class="go">  [23] .got.plt          PROGBITS        08049644 000644 000014 04  WA  0   0  4</span>
<span class="go">  [24] .data             PROGBITS        08049658 000658 000008 00  WA  0   0  4</span>
<span class="go">  [25] .bss              NOBITS          08049660 000660 000004 00  WA  0   0  1</span>
<span class="go">  [26] .comment          PROGBITS        00000000 000660 000039 01  MS  0   0  1</span>
<span class="go">  [27] .shstrtab         STRTAB          00000000 000699 000106 00      0   0  1</span>
<span class="go">  [28] .symtab           SYMTAB          00000000 0007a0 000420 10     29  45  4</span>
<span class="go">  [29] .strtab           STRTAB          00000000 000bc0 00023f 00      0   0  1</span>
<span class="go">Key to Flags:</span>
<span class="go">  W (write), A (alloc), X (execute), M (merge), S (strings)</span>
<span class="go">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span>
<span class="go">  O (extra OS processing required) o (OS specific), p (processor specific)</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">.init:</th><td class="field-body">This section holds initialisation routines, which are executed before the
main program entry point (ie. main function for C programs). This section is
populated by the linker, according to the target OS, and it can be customised
with a linker script.</td>
</tr>
<tr class="field-even field"><th class="field-name">.fini:</th><td class="field-body">This section holds termination routines, which are executed when a program
terminates. This section is populated by the linker, according to the target
OS, and it can be customised with a linker script.</td>
</tr>
<tr class="field-odd field"><th class="field-name">.text:</th><td class="field-body">This section holds the executable instructions of a program.</td>
</tr>
<tr class="field-even field"><th class="field-name">.data:</th><td class="field-body">This section holds initialised variables.</td>
</tr>
<tr class="field-odd field"><th class="field-name">.bss:</th><td class="field-body">This section holds uninitialised variables, which are initialised to zero
when the program starts executing.</td>
</tr>
<tr class="field-even field"><th class="field-name">.rodata:</th><td class="field-body">This section holds initialised readonly variables.</td>
</tr>
<tr class="field-odd field"><th class="field-name">.plt:</th><td class="field-body">This section holds the procedure linkage table.</td>
</tr>
</tbody>
</table>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">Program Headers:</span>
<span class="go">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span>
<span class="go">  PHDR           0x000034 0x08048034 0x08048034 0x00100 0x00100 R E 0x4</span>
<span class="go">  INTERP         0x000134 0x08048134 0x08048134 0x00013 0x00013 R   0x1</span>
<span class="go">      [Requesting program interpreter: /lib/ld-linux.so.2]</span>
<span class="go">  LOAD           0x000000 0x08048000 0x08048000 0x0054c 0x0054c R E 0x1000</span>
<span class="go">  LOAD           0x00054c 0x0804954c 0x0804954c 0x00114 0x00118 RW  0x1000</span>
<span class="go">  DYNAMIC        0x000558 0x08049558 0x08049558 0x000e8 0x000e8 RW  0x4</span>
<span class="go">  NOTE           0x000148 0x08048148 0x08048148 0x00044 0x00044 R   0x4</span>
<span class="go">  GNU_EH_FRAME   0x000470 0x08048470 0x08048470 0x0002c 0x0002c R   0x4</span>
<span class="go">  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10</span>

<span class="go"> Section to Segment mapping:</span>
<span class="go">  Segment Sections...</span>
<span class="go">   00</span>
<span class="go">   01     .interp</span>
<span class="go">   02     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr</span>
<span class="go">          .gnu.version .gnu.version_r .rel.dyn .rel.plt .init .plt .text</span>
<span class="go">          .fini .rodata .eh_frame_hdr .eh_frame</span>
<span class="go">   03     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss</span>
<span class="go">   04     .dynamic</span>
<span class="go">   05     .note.ABI-tag .note.gnu.build-id</span>
<span class="go">   06     .eh_frame_hdr</span>
<span class="go">   07</span>
</pre></div>
</td></tr></table></div>
<p>To quote the <a class="reference external" href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ELF</a> standard:</p>
<p>&#8220;An executable or shared object file&#8217;s program header table is an array of
structures, each describing a segment or other information the system needs to
prepare the program for execution.  An object file segment contains one or more
sections.&#8221;</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">Dynamic section at offset 0x558 contains 24 entries:</span>
<span class="go">  Tag        Type                         Name/Value</span>
<span class="go"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span>
<span class="go"> 0x0000000c (INIT)                       0x8048274</span>
<span class="go"> 0x0000000d (FINI)                       0x8048454</span>
<span class="go"> 0x00000019 (INIT_ARRAY)                 0x804954c</span>
<span class="go"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span>
<span class="go"> 0x0000001a (FINI_ARRAY)                 0x8049550</span>
<span class="go"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span>
<span class="go"> 0x6ffffef5 (GNU_HASH)                   0x804818c</span>
<span class="go"> 0x00000005 (STRTAB)                     0x80481ec</span>
<span class="go"> 0x00000006 (SYMTAB)                     0x80481ac</span>
<span class="go"> 0x0000000a (STRSZ)                      69 (bytes)</span>
<span class="go"> 0x0000000b (SYMENT)                     16 (bytes)</span>
<span class="go"> 0x00000015 (DEBUG)                      0x0</span>
<span class="go"> 0x00000003 (PLTGOT)                     0x8049644</span>
<span class="go"> 0x00000002 (PLTRELSZ)                   16 (bytes)</span>
<span class="go"> 0x00000014 (PLTREL)                     REL</span>
<span class="go"> 0x00000017 (JMPREL)                     0x8048264</span>
<span class="go"> 0x00000011 (REL)                        0x804825c</span>
<span class="go"> 0x00000012 (RELSZ)                      8 (bytes)</span>
<span class="go"> 0x00000013 (RELENT)                     8 (bytes)</span>
<span class="go"> 0x6ffffffe (VERNEED)                    0x804823c</span>
<span class="go"> 0x6fffffff (VERNEEDNUM)                 1</span>
<span class="go"> 0x6ffffff0 (VERSYM)                     0x8048232</span>
<span class="go"> 0x00000000 (NULL)                       0x0</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">.dynamic:</th><td class="field-body">This section holds dynamic linking information. Dynamic linking (see the
<a class="reference external" href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ELF</a> standard, part 2), takes place during program execution. During the
exec() system call, control is passed to an interpreter who is responsible
for reading the executable&#8217;s segments into memory.</td>
</tr>
</tbody>
</table>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">Relocation section &#39;.rel.dyn&#39; at offset 0x25c contains 1 entries:</span>
<span class="go"> Offset     Info    Type            Sym.Value  Sym. Name</span>
<span class="go">08049640  00000106 R_386_GLOB_DAT    00000000   __gmon_start__</span>

<span class="go">Relocation section &#39;.rel.plt&#39; at offset 0x264 contains 2 entries:</span>
<span class="go"> Offset     Info    Type            Sym.Value  Sym. Name</span>
<span class="go">08049650  00000107 R_386_JUMP_SLOT   00000000   __gmon_start__</span>
<span class="go">08049654  00000207 R_386_JUMP_SLOT   00000000   __libc_start_main</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">.rel.dyn:</th><td class="field-body"><p class="first">This section holds relocation information for the .dynamic section.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">.rel.plt:</th><td class="field-body"><p class="first">This section holds relocation information for the .plt section.</p>
<p>From the <a class="reference external" href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ELF</a> standard:</p>
<p class="last">&#8220;Relocation is the process of connecting symbolic references with symbolic
definitions.  For example, when a program calls a function, the associated
call instruction must transfer control to the proper destination address at
execution.  In other words, relocatable files must have information that
describes how to modify their section contents, thus allowing executable and
shared object files to hold the right information for a process&#8217;s program
image.&#8221;</p>
</td>
</tr>
</tbody>
</table>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">Symbol table &#39;.dynsym&#39; contains 4 entries:</span>
<span class="go">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span>
<span class="go">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span>
<span class="go">     1: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span>
<span class="go">     2: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.0 (2)</span>
<span class="go">     3: 0804846c     4 OBJECT  GLOBAL DEFAULT   15 _IO_stdin_used</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">.dynsym:</th><td class="field-body">This section holds the dynamic linking symbol table.</td>
</tr>
</tbody>
</table>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></div></td><td class="code"><div class="highlight"><pre><span class="go">Symbol table &#39;.symtab&#39; contains 66 entries:</span>
<span class="go">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span>
<span class="go">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span>
<span class="go">     1: 08048134     0 SECTION LOCAL  DEFAULT    1</span>
<span class="go">     2: 08048148     0 SECTION LOCAL  DEFAULT    2</span>
<span class="go">     3: 08048168     0 SECTION LOCAL  DEFAULT    3</span>
<span class="go">     4: 0804818c     0 SECTION LOCAL  DEFAULT    4</span>
<span class="go">     5: 080481ac     0 SECTION LOCAL  DEFAULT    5</span>
<span class="go">     6: 080481ec     0 SECTION LOCAL  DEFAULT    6</span>
<span class="go">     7: 08048232     0 SECTION LOCAL  DEFAULT    7</span>
<span class="go">     8: 0804823c     0 SECTION LOCAL  DEFAULT    8</span>
<span class="go">     9: 0804825c     0 SECTION LOCAL  DEFAULT    9</span>
<span class="go">    10: 08048264     0 SECTION LOCAL  DEFAULT   10</span>
<span class="go">    11: 08048274     0 SECTION LOCAL  DEFAULT   11</span>
<span class="go">    12: 080482a0     0 SECTION LOCAL  DEFAULT   12</span>
<span class="go">    13: 080482d0     0 SECTION LOCAL  DEFAULT   13</span>
<span class="go">    14: 08048454     0 SECTION LOCAL  DEFAULT   14</span>
<span class="go">    15: 08048468     0 SECTION LOCAL  DEFAULT   15</span>
<span class="go">    16: 08048470     0 SECTION LOCAL  DEFAULT   16</span>
<span class="go">    17: 0804849c     0 SECTION LOCAL  DEFAULT   17</span>
<span class="go">    18: 0804954c     0 SECTION LOCAL  DEFAULT   18</span>
<span class="go">    19: 08049550     0 SECTION LOCAL  DEFAULT   19</span>
<span class="go">    20: 08049554     0 SECTION LOCAL  DEFAULT   20</span>
<span class="go">    21: 08049558     0 SECTION LOCAL  DEFAULT   21</span>
<span class="go">    22: 08049640     0 SECTION LOCAL  DEFAULT   22</span>
<span class="go">    23: 08049644     0 SECTION LOCAL  DEFAULT   23</span>
<span class="go">    24: 08049658     0 SECTION LOCAL  DEFAULT   24</span>
<span class="go">    25: 08049660     0 SECTION LOCAL  DEFAULT   25</span>
<span class="go">    26: 00000000     0 SECTION LOCAL  DEFAULT   26</span>
<span class="go">    27: 00000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c</span>
<span class="go">    28: 08049554     0 OBJECT  LOCAL  DEFAULT   20 __JCR_LIST__</span>
<span class="go">    29: 08048310     0 FUNC    LOCAL  DEFAULT   13 deregister_tm_clones</span>
<span class="go">    30: 08048340     0 FUNC    LOCAL  DEFAULT   13 register_tm_clones</span>
<span class="go">    31: 08048380     0 FUNC    LOCAL  DEFAULT   13 __do_global_dtors_aux</span>
<span class="go">    32: 08049660     1 OBJECT  LOCAL  DEFAULT   25 completed.6279</span>
<span class="go">    33: 08049550     0 OBJECT  LOCAL  DEFAULT   19 __do_global_dtors_aux_fin</span>
<span class="go">    34: 080483a0     0 FUNC    LOCAL  DEFAULT   13 frame_dummy</span>
<span class="go">    35: 0804954c     0 OBJECT  LOCAL  DEFAULT   18 __frame_dummy_init_array_</span>
<span class="go">    36: 00000000     0 FILE    LOCAL  DEFAULT  ABS main.c</span>
<span class="go">    37: 00000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c</span>
<span class="go">    38: 08048548     0 OBJECT  LOCAL  DEFAULT   17 __FRAME_END__</span>
<span class="go">    39: 08049554     0 OBJECT  LOCAL  DEFAULT   20 __JCR_END__</span>
<span class="go">    40: 00000000     0 FILE    LOCAL  DEFAULT  ABS</span>
<span class="go">    41: 08049550     0 NOTYPE  LOCAL  DEFAULT   18 __init_array_end</span>
<span class="go">    42: 08049558     0 OBJECT  LOCAL  DEFAULT   21 _DYNAMIC</span>
<span class="go">    43: 0804954c     0 NOTYPE  LOCAL  DEFAULT   18 __init_array_start</span>
<span class="go">    44: 08049644     0 OBJECT  LOCAL  DEFAULT   23 _GLOBAL_OFFSET_TABLE_</span>
<span class="go">    45: 08048450     2 FUNC    GLOBAL DEFAULT   13 __libc_csu_fini</span>
<span class="go">    46: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span>
<span class="go">    47: 08048300     4 FUNC    GLOBAL HIDDEN    13 __x86.get_pc_thunk.bx</span>
<span class="go">    48: 08049658     0 NOTYPE  WEAK   DEFAULT   24 data_start</span>
<span class="go">    49: 08049660     0 NOTYPE  GLOBAL DEFAULT   24 _edata</span>
<span class="go">    50: 08048454     0 FUNC    GLOBAL DEFAULT   14 _fini</span>
<span class="go">    51: 08049658     0 NOTYPE  GLOBAL DEFAULT   24 __data_start</span>
<span class="go">    52: 00000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span>
<span class="go">    53: 0804965c     0 OBJECT  GLOBAL HIDDEN    24 __dso_handle</span>
<span class="go">    54: 0804846c     4 OBJECT  GLOBAL DEFAULT   15 _IO_stdin_used</span>
<span class="go">    55: 00000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@@GLIBC_</span>
<span class="go">    56: 080483e0    97 FUNC    GLOBAL DEFAULT   13 __libc_csu_init</span>
<span class="go">    57: 08049664     0 NOTYPE  GLOBAL DEFAULT   25 _end</span>
<span class="go">    58: 080482d0     0 FUNC    GLOBAL DEFAULT   13 _start</span>
<span class="go">    59: 08048468     4 OBJECT  GLOBAL DEFAULT   15 _fp_hw</span>
<span class="go">    60: 08049660     0 NOTYPE  GLOBAL DEFAULT   25 __bss_start</span>
<span class="go">    61: 080483cb    10 FUNC    GLOBAL DEFAULT   13 main</span>
<span class="go">    62: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses</span>
<span class="go">    63: 08049660     0 OBJECT  GLOBAL HIDDEN    24 __TMC_END__</span>
<span class="go">    64: 00000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span>
<span class="go">    65: 08048274     0 FUNC    GLOBAL DEFAULT   11 _init</span>
</pre></div>
</td></tr></table></div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">.symtab:</th><td class="field-body">This section holds a symbol table. We can see in this table our main.c file,
and our main function at address 080483cb. Try compiling the same program
with -static, and see how the symbol table changes.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="program-linking-and-loading">
<h3>Program linking and loading<a class="headerlink" href="#program-linking-and-loading" title="Permalink to this headline">¶</a></h3>
<p>Let us now study the linking and loading processes. The program we will
study is the following</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>If we try to compile this with the compiler that comes with our distribution,
the program compiles cleanly. However, if we use our cross-compilers to compile
this program we get errors</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-gcc main.c
<span class="go">ld: cannot find crt0.o: No such file or directory</span>
<span class="go">ld: cannot find -lc</span>
<span class="go">collect2: error: ld returned 1 exit status</span>
</pre></div>
</td></tr></table></div>
<p>In this example we asked our cross-compiler to link against the C standard
library, but the linker could not find the crt0.o file. What is the
crt0.o file?</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-gcc -nostdlib -ffreestanding main.c
<span class="go">ld: warning: cannot find entry symbol _start; defaulting to 08048054</span>
</pre></div>
</td></tr></table></div>
<p>In this example we asked our cross-compiler to not use the C standard library,
but the linker could not find the _start symbol. What is the _start symbol?</p>
<p>If we have a look at the ELF again, we see in the header the field
&#8216;Entry point address&#8217;</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> readelf -h a.out <span class="p">|</span> grep <span class="s1">&#39;Entry&#39;</span>
<span class="go">  Entry point address:               0x80482d0</span>
</pre></div>
</td></tr></table></div>
<p>Let us dissassemble our program and focus on the .text section, which is the
section that holds the executable instructions of a program</p>
<div class="highlight-objdump"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</pre></div></td><td class="code"><div class="highlight"><pre><span class="x"># objdump -S a.out</span>
<span class="nl">a.out</span><span class="p">:</span>     file format <span class="s">elf32-i386</span>


Disassembly of section <span class="nl">.plt</span><span class="p">:</span>

<span class="x">[...]</span>

<span class="mh">080482c0</span> <span class="p">&lt;</span><span class="nf">__libc_start_main@plt</span><span class="p">&gt;:</span>
<span class="x"> 80482c0:   ff 25 54 96 04 08       jmp    *0x8049654</span>
<span class="x"> 80482c6:   68 08 00 00 00          push   $0x8</span>
<span class="x"> 80482cb:   e9 d0 ff ff ff          jmp    80482a0 &lt;_init+0x2c&gt;</span>

Disassembly of section <span class="nl">.text</span><span class="p">:</span>

<span class="mh">080482d0</span> <span class="p">&lt;</span><span class="nf">_start</span><span class="p">&gt;:</span>
<span class="x"> 80482d0:   31 ed                   xor    %ebp,%ebp</span>
<span class="x"> 80482d2:   5e                      pop    %esi</span>
<span class="x"> 80482d3:   89 e1                   mov    %esp,%ecx</span>
<span class="x"> 80482d5:   83 e4 f0                and    $0xfffffff0,%esp</span>
<span class="x"> 80482d8:   50                      push   %eax</span>
<span class="x"> 80482d9:   54                      push   %esp</span>
<span class="x"> 80482da:   52                      push   %edx</span>
<span class="x"> 80482db:   68 50 84 04 08          push   $0x8048450</span>
<span class="x"> 80482e0:   68 e0 83 04 08          push   $0x80483e0</span>
<span class="x"> 80482e5:   51                      push   %ecx</span>
<span class="x"> 80482e6:   56                      push   %esi</span>
<span class="x"> 80482e7:   68 cb 83 04 08          push   $0x80483cb</span>
<span class="x"> 80482ec:   e8 cf ff ff ff          call   80482c0 &lt;__libc_start_main@plt&gt;</span>
<span class="x"> 80482f1:   f4                      hlt</span>
<span class="x"> 80482f2:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482f4:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482f6:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482f8:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482fa:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482fc:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482fe:   66 90                   xchg   %ax,%ax</span>

<span class="mh">08048300</span> <span class="p">&lt;</span><span class="nf">__x86.get_pc_thunk.bx</span><span class="p">&gt;:</span>
<span class="x"> 8048300:   8b 1c 24                mov    (%esp),%ebx</span>
<span class="x"> 8048303:   c3                      ret</span>
<span class="x"> 8048304:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 8048306:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 8048308:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 804830a:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 804830c:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 804830e:   66 90                   xchg   %ax,%ax</span>

<span class="mh">08048310</span> <span class="p">&lt;</span><span class="nf">deregister_tm_clones</span><span class="p">&gt;:</span>
<span class="x"> 8048310:   b8 63 96 04 08          mov    $0x8049663,%eax</span>
<span class="x"> 8048315:   2d 60 96 04 08          sub    $0x8049660,%eax</span>
<span class="x"> 804831a:   83 f8 06                cmp    $0x6,%eax</span>
<span class="x"> 804831d:   76 1a                   jbe    8048339 &lt;deregister_tm_clones+0x29&gt;</span>
<span class="x"> 804831f:   b8 00 00 00 00          mov    $0x0,%eax</span>
<span class="x"> 8048324:   85 c0                   test   %eax,%eax</span>
<span class="x"> 8048326:   74 11                   je     8048339 &lt;deregister_tm_clones+0x29&gt;</span>
<span class="x"> 8048328:   55                      push   %ebp</span>
<span class="x"> 8048329:   89 e5                   mov    %esp,%ebp</span>
<span class="x"> 804832b:   83 ec 14                sub    $0x14,%esp</span>
<span class="x"> 804832e:   68 60 96 04 08          push   $0x8049660</span>
<span class="x"> 8048333:   ff d0                   call   *%eax</span>
<span class="x"> 8048335:   83 c4 10                add    $0x10,%esp</span>
<span class="x"> 8048338:   c9                      leave</span>
<span class="x"> 8048339:   f3 c3                   repz ret</span>
<span class="x"> 804833b:   90                      nop</span>
<span class="x"> 804833c:   8d 74 26 00             lea    0x0(%esi,%eiz,1),%esi</span>

<span class="mh">08048340</span> <span class="p">&lt;</span><span class="nf">register_tm_clones</span><span class="p">&gt;:</span>
<span class="x"> 8048340:   b8 60 96 04 08          mov    $0x8049660,%eax</span>
<span class="x"> 8048345:   2d 60 96 04 08          sub    $0x8049660,%eax</span>
<span class="x"> 804834a:   c1 f8 02                sar    $0x2,%eax</span>
<span class="x"> 804834d:   89 c2                   mov    %eax,%edx</span>
<span class="x"> 804834f:   c1 ea 1f                shr    $0x1f,%edx</span>
<span class="x"> 8048352:   01 d0                   add    %edx,%eax</span>
<span class="x"> 8048354:   d1 f8                   sar    %eax</span>
<span class="x"> 8048356:   74 1b                   je     8048373 &lt;register_tm_clones+0x33&gt;</span>
<span class="x"> 8048358:   ba 00 00 00 00          mov    $0x0,%edx</span>
<span class="x"> 804835d:   85 d2                   test   %edx,%edx</span>
<span class="x"> 804835f:   74 12                   je     8048373 &lt;register_tm_clones+0x33&gt;</span>
<span class="x"> 8048361:   55                      push   %ebp</span>
<span class="x"> 8048362:   89 e5                   mov    %esp,%ebp</span>
<span class="x"> 8048364:   83 ec 10                sub    $0x10,%esp</span>
<span class="x"> 8048367:   50                      push   %eax</span>
<span class="x"> 8048368:   68 60 96 04 08          push   $0x8049660</span>
<span class="x"> 804836d:   ff d2                   call   *%edx</span>
<span class="x"> 804836f:   83 c4 10                add    $0x10,%esp</span>
<span class="x"> 8048372:   c9                      leave</span>
<span class="x"> 8048373:   f3 c3                   repz ret</span>
<span class="x"> 8048375:   8d 74 26 00             lea    0x0(%esi,%eiz,1),%esi</span>
<span class="x"> 8048379:   8d bc 27 00 00 00 00    lea    0x0(%edi,%eiz,1),%edi</span>

<span class="mh">08048380</span> <span class="p">&lt;</span><span class="nf">__do_global_dtors_aux</span><span class="p">&gt;:</span>
<span class="x"> 8048380:   80 3d 60 96 04 08 00    cmpb   $0x0,0x8049660</span>
<span class="x"> 8048387:   75 13                   jne    804839c &lt;__do_global_dtors_aux+0x1c&gt;</span>
<span class="x"> 8048389:   55                      push   %ebp</span>
<span class="x"> 804838a:   89 e5                   mov    %esp,%ebp</span>
<span class="x"> 804838c:   83 ec 08                sub    $0x8,%esp</span>
<span class="x"> 804838f:   e8 7c ff ff ff          call   8048310 &lt;deregister_tm_clones&gt;</span>
<span class="x"> 8048394:   c6 05 60 96 04 08 01    movb   $0x1,0x8049660</span>
<span class="x"> 804839b:   c9                      leave</span>
<span class="x"> 804839c:   f3 c3                   repz ret</span>
<span class="x"> 804839e:   66 90                   xchg   %ax,%ax</span>

<span class="mh">080483a0</span> <span class="p">&lt;</span><span class="nf">frame_dummy</span><span class="p">&gt;:</span>
<span class="x"> 80483a0:   b8 54 95 04 08          mov    $0x8049554,%eax</span>
<span class="x"> 80483a5:   8b 10                   mov    (%eax),%edx</span>
<span class="x"> 80483a7:   85 d2                   test   %edx,%edx</span>
<span class="x"> 80483a9:   75 05                   jne    80483b0 &lt;frame_dummy+0x10&gt;</span>
<span class="x"> 80483ab:   eb 93                   jmp    8048340 &lt;register_tm_clones&gt;</span>
<span class="x"> 80483ad:   8d 76 00                lea    0x0(%esi),%esi</span>
<span class="x"> 80483b0:   ba 00 00 00 00          mov    $0x0,%edx</span>
<span class="x"> 80483b5:   85 d2                   test   %edx,%edx</span>
<span class="x"> 80483b7:   74 f2                   je     80483ab &lt;frame_dummy+0xb&gt;</span>
<span class="x"> 80483b9:   55                      push   %ebp</span>
<span class="x"> 80483ba:   89 e5                   mov    %esp,%ebp</span>
<span class="x"> 80483bc:   83 ec 14                sub    $0x14,%esp</span>
<span class="x"> 80483bf:   50                      push   %eax</span>
<span class="x"> 80483c0:   ff d2                   call   *%edx</span>
<span class="x"> 80483c2:   83 c4 10                add    $0x10,%esp</span>
<span class="x"> 80483c5:   c9                      leave</span>
<span class="x"> 80483c6:   e9 75 ff ff ff          jmp    8048340 &lt;register_tm_clones&gt;</span>

<span class="mh">080483cb</span> <span class="p">&lt;</span><span class="nf">main</span><span class="p">&gt;:</span>
<span class="x"> 80483cb:   55                      push   %ebp</span>
<span class="x"> 80483cc:   89 e5                   mov    %esp,%ebp</span>
<span class="x"> 80483ce:   b8 00 00 00 00          mov    $0x0,%eax</span>
<span class="x"> 80483d3:   5d                      pop    %ebp</span>
<span class="x"> 80483d4:   c3                      ret</span>
<span class="x"> 80483d5:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80483d7:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80483d9:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80483db:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80483dd:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80483df:   90                      nop</span>

<span class="mh">080483e0</span> <span class="p">&lt;</span><span class="nf">__libc_csu_init</span><span class="p">&gt;:</span>
<span class="x"> 80483e0:   55                      push   %ebp</span>
<span class="x"> 80483e1:   57                      push   %edi</span>
<span class="x"> 80483e2:   31 ff                   xor    %edi,%edi</span>
<span class="x"> 80483e4:   56                      push   %esi</span>
<span class="x"> 80483e5:   53                      push   %ebx</span>
<span class="x"> 80483e6:   e8 15 ff ff ff          call   8048300 &lt;__x86.get_pc_thunk.bx&gt;</span>
<span class="x"> 80483eb:   81 c3 59 12 00 00       add    $0x1259,%ebx</span>
<span class="x"> 80483f1:   83 ec 1c                sub    $0x1c,%esp</span>
<span class="x"> 80483f4:   8b 6c 24 30             mov    0x30(%esp),%ebp</span>
<span class="x"> 80483f8:   8d b3 0c ff ff ff       lea    -0xf4(%ebx),%esi</span>
<span class="x"> 80483fe:   e8 71 fe ff ff          call   8048274 &lt;_init&gt;</span>
<span class="x"> 8048403:   8d 83 08 ff ff ff       lea    -0xf8(%ebx),%eax</span>
<span class="x"> 8048409:   29 c6                   sub    %eax,%esi</span>
<span class="x"> 804840b:   c1 fe 02                sar    $0x2,%esi</span>
<span class="x"> 804840e:   85 f6                   test   %esi,%esi</span>
<span class="x"> 8048410:   74 27                   je     8048439 &lt;__libc_csu_init+0x59&gt;</span>
<span class="x"> 8048412:   8d b6 00 00 00 00       lea    0x0(%esi),%esi</span>
<span class="x"> 8048418:   8b 44 24 38             mov    0x38(%esp),%eax</span>
<span class="x"> 804841c:   89 2c 24                mov    %ebp,(%esp)</span>
<span class="x"> 804841f:   89 44 24 08             mov    %eax,0x8(%esp)</span>
<span class="x"> 8048423:   8b 44 24 34             mov    0x34(%esp),%eax</span>
<span class="x"> 8048427:   89 44 24 04             mov    %eax,0x4(%esp)</span>
<span class="x"> 804842b:   ff 94 bb 08 ff ff ff    call   *-0xf8(%ebx,%edi,4)</span>
<span class="x"> 8048432:   83 c7 01                add    $0x1,%edi</span>
<span class="x"> 8048435:   39 f7                   cmp    %esi,%edi</span>
<span class="x"> 8048437:   75 df                   jne    8048418 &lt;__libc_csu_init+0x38&gt;</span>
<span class="x"> 8048439:   83 c4 1c                add    $0x1c,%esp</span>
<span class="x"> 804843c:   5b                      pop    %ebx</span>
<span class="x"> 804843d:   5e                      pop    %esi</span>
<span class="x"> 804843e:   5f                      pop    %edi</span>
<span class="x"> 804843f:   5d                      pop    %ebp</span>
<span class="x"> 8048440:   c3                      ret</span>
<span class="x"> 8048441:   eb 0d                   jmp    8048450 &lt;__libc_csu_fini&gt;</span>
<span class="x"> 8048443:   90                      nop</span>
<span class="x"> 8048444:   90                      nop</span>
<span class="x"> 8048445:   90                      nop</span>
<span class="x"> 8048446:   90                      nop</span>
<span class="x"> 8048447:   90                      nop</span>
<span class="x"> 8048448:   90                      nop</span>
<span class="x"> 8048449:   90                      nop</span>
<span class="x"> 804844a:   90                      nop</span>
<span class="x"> 804844b:   90                      nop</span>
<span class="x"> 804844c:   90                      nop</span>
<span class="x"> 804844d:   90                      nop</span>
<span class="x"> 804844e:   90                      nop</span>
<span class="x"> 804844f:   90                      nop</span>

<span class="mh">08048450</span> <span class="p">&lt;</span><span class="nf">__libc_csu_fini</span><span class="p">&gt;:</span>
<span class="x"> 8048450:   f3 c3                   repz ret</span>
</pre></div>
</td></tr></table></div>
<p>Surprisingly, our main function is only a tiny part of the program&#8217;s .text
section, and is not even the first function being run when the program
is loaded. The entry point address we got by reading the ELF, points to the
_start function. So where does this function come from?</p>
<p>The _start function is part of the C library, and is contained in the crt0.o
file. To quote the
<a class="reference external" href="https://dev.gentoo.org/~vapier/crt.txt">Gentoo documentation</a>:</p>
<p>&#8220;On uClibc/glibc systems, this object initializes very early ABI requirements
(like the stack or frame pointer), setting up the argc/argv/env values, and
then passing pointers to the init/fini/main funcs to the internal libc main
which in turn does more general bootstrapping before finally calling the real
main function.</p>
<p>glibc ports call this file &#8216;start.S&#8217; while uClibc ports call this crt0.S or
crt1.S (depending on what their gcc expects).&#8221;</p>
<p>But before we go through the _start section we need to discuss what happens
when a program is run. A program is run through the execve() system call (see
the man page for execve). To quote the <a class="reference external" href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">Linux x86 Program Start Up</a>:</p>
<p>&#8220;To summarize, it will set up a stack for you, and push onto it argc, argv, and
envp. The file descriptions 0, 1, and 2, (stdin, stdout, stderr), are left to
whatever the shell set them to. The loader does much work for you setting up
your relocations, and as we&#8217;ll see much later, calling your preinitializers.
When everything is ready, control is handed to your program by calling _start()&#8221;</p>
<p>So, in detail, the _start section does the following (from the start.S
<a class="reference external" href="https://sourceware.org/git/?p=glibc.git;a=blob_plain;f=sysdeps/i386/start.S;hb=HEAD">source code</a>):</p>
<div class="highlight-objdump"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span class="mh">080482d0</span> <span class="p">&lt;</span><span class="nf">_start</span><span class="p">&gt;:</span>
<span class="x"> /* Clear the frame pointer, to mark the outermost frame. */</span>
<span class="x"> 80482d0:   31 ed                   xor    %ebp,%ebp</span>
<span class="x"> /* Put argc into %esi. */</span>
<span class="x"> 80482d2:   5e                      pop    %esi</span>
<span class="x"> /* Put argv into %ecx. */</span>
<span class="x"> 80482d3:   89 e1                   mov    %esp,%ecx</span>
<span class="x"> /* 16-byte alignment. */</span>
<span class="x"> 80482d5:   83 e4 f0                and    $0xfffffff0,%esp</span>
<span class="x"> 80482d8:   50                      push   %eax</span>
<span class="x"> 80482d9:   54                      push   %esp</span>
<span class="x"> 80482da:   52                      push   %edx</span>
<span class="x"> /* Push the address of .fini. */</span>
<span class="x"> 80482db:   68 50 84 04 08          push   $0x8048450</span>
<span class="x"> /* Push the address of .init. */</span>
<span class="x"> 80482e0:   68 e0 83 04 08          push   $0x80483e0</span>
<span class="x"> /* Push argv. */</span>
<span class="x"> 80482e5:   51                      push   %ecx</span>
<span class="x"> /* Push argc. */</span>
<span class="x"> 80482e6:   56                      push   %esi</span>
<span class="x"> /* Push the address of the main function. */</span>
<span class="x"> 80482e7:   68 cb 83 04 08          push   $0x80483cb</span>
<span class="x"> /* Call the main function through __libc_start_main. */</span>
<span class="x"> 80482ec:   e8 cf ff ff ff          call   80482c0 &lt;__libc_start_main@plt&gt;</span>
<span class="x"> 80482f1:   f4                      hlt</span>
<span class="x"> 80482f2:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482f4:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482f6:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482f8:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482fa:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482fc:   66 90                   xchg   %ax,%ax</span>
<span class="x"> 80482fe:   66 90                   xchg   %ax,%ax</span>
</pre></div>
</td></tr></table></div>
<p>The function __libc_start_main lives in glibc source tree in
<a class="reference external" href="https://sourceware.org/git/?p=glibc.git;a=blob_plain;f=csu/libc-start.c;hb=HEAD">csu/libc-start.c</a>.
The function __libc_csu_init is a constructor, while the function
__libc_csu_fini is a destructor. These functions live in glibc source tree in
<a class="reference external" href="https://sourceware.org/git/?p=glibc.git;a=blob_plain;f=csu/elf-init.c;hb=HEAD">csu/elf-init.c</a>.
I will not discuss the inner workings of these function, but if you want to know
more please consult the <a class="reference external" href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">Linux x86 Program Start Up</a>.</p>
<p>So now that we know what crt0.o and _start are, lets revisit the two error
messages that we received when were building with our cross compiler.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-gcc main.c
<span class="go">ld: cannot find crt0.o: No such file or directory</span>
<span class="go">ld: cannot find -lc</span>
<span class="go">collect2: error: ld returned 1 exit status</span>
</pre></div>
</td></tr></table></div>
<p>The standard library that comes with the cross compiler is minimal, as the
cross compiler targets an OS uknown to glibc. As such there is no crt0.o file.</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-gcc -nostdlib -ffreestanding main.c
<span class="go">ld: warning: cannot find entry symbol _start; defaulting to 08048054</span>
</pre></div>
</td></tr></table></div>
<p>In this example we asked the cross compiler to build the program without
using the standard library. Even though it does not attempt to locate the
crt0.o file, it needs the entry point of the program.
Hence, we need to provide our own _start function. A minimal start.S file
is the following</p>
<div class="highlight-gas"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="na">.section</span> <span class="no">.text</span>
<span class="na">.global</span> <span class="no">_start</span>
<span class="na">.type</span> <span class="no">_start</span><span class="p">,</span> <span class="na">@function</span>
<span class="nl">_start:</span>
   <span class="nf">andl</span> <span class="no">$0xfffffff0</span><span class="p">,</span> <span class="nv">%esp</span>  <span class="c"># align the stack to a 16-byte boundary</span>
   <span class="nf">call</span> <span class="no">main</span>               <span class="c"># call the main function</span>
<span class="nl">loop:</span>
   <span class="nf">jmp</span> <span class="no">_start</span>              <span class="c"># go back to _start</span>
<span class="na">.size</span> <span class="no">_start</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_start</span>
</pre></div>
</td></tr></table></div>
<p>The most confusing part of this program is the call to &#8220;jmp _start&#8221;. The _start
function cannot return, as there is no frame before _start to continue execution
at. Returning from _start would result in a segmentation fault. If we
were building a program for linux, at this point we would be making a system
call to exit the program. However, this is a standalone program and it cannot
make system calls. So i decided to let it loop forever, even though that might
not be the best approach.</p>
<p>The main program is a minimal CPP program</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#if defined(__cplusplus)</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span>
<span class="cp">#endif</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Since we are using our own start.S script, we need to provide our own linker
script. A simple linker script is the following</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre>ENTRY(_start)

SECTIONS
{
  . = 0x10000;
  .text : { *(.text) }
  . = 0x8000000;
  .data : { *(.data) }
  .bss : { *(.bss) }
}
</pre></div>
</td></tr></table></div>
<p>This script tells the linker that _start is the entry point of the program, and
that the program has the sections .text starting at address 0x10000, .data
starting at address 0x8000000, and .bss. Lets compile and have a look at the ELF</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-as start.S -o start.o
<span class="gp">#</span> i686-elf-g++ -c -o main.o main.cpp
<span class="gp">#</span> i686-elf-g++ -T i686.ld -o a.out -ffreestanding -nostdlib start.o main.o
<span class="gp">#</span> readelf -a a.out
<span class="go">ELF Header:</span>
<span class="go">Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00</span>
<span class="go">Class:                             ELF32</span>
<span class="go">Data:                              2&#39;s complement, little endian</span>
<span class="go">Version:                           1 (current)</span>
<span class="go">OS/ABI:                            UNIX - System V</span>
<span class="go">ABI Version:                       0</span>
<span class="go">Type:                              EXEC (Executable file)</span>
<span class="go">Machine:                           Intel 80386</span>
<span class="go">Version:                           0x1</span>
<span class="go">Entry point address:               0x10000</span>
<span class="go">Start of program headers:          52 (bytes into file)</span>
<span class="go">Start of section headers:          4424 (bytes into file)</span>
<span class="go">Flags:                             0x0</span>
<span class="go">Size of this header:               52 (bytes)</span>
<span class="go">Size of program headers:           32 (bytes)</span>
<span class="go">Number of program headers:         1</span>
<span class="go">Size of section headers:           40 (bytes)</span>
<span class="go">Number of section headers:         7</span>
<span class="go">Section header string table index: 4</span>

<span class="go">Section Headers:</span>
<span class="go">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span>
<span class="go">[ 0]                   NULL            00000000 000000 000000 00      0   0  0</span>
<span class="go">[ 1] .text             PROGBITS        00010000 001000 000014 00  AX  0   0  1</span>
<span class="go">[ 2] .eh_frame         PROGBITS        00010014 001014 000038 00   A  0   0  4</span>
<span class="go">[ 3] .comment          PROGBITS        00000000 00104c 000011 01  MS  0   0  1</span>
<span class="go">[ 4] .shstrtab         STRTAB          00000000 001113 000034 00      0   0  1</span>
<span class="go">[ 5] .symtab           SYMTAB          00000000 001060 000090 10      6   7  4</span>
<span class="go">[ 6] .strtab           STRTAB          00000000 0010f0 000023 00      0   0  1</span>
<span class="go">Key to Flags:</span>
<span class="go">W (write), A (alloc), X (execute), M (merge), S (strings)</span>
<span class="go">I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span>
<span class="go">O (extra OS processing required) o (OS specific), p (processor specific)</span>

<span class="go">There are no section groups in this file.</span>

<span class="go">Program Headers:</span>
<span class="go">Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span>
<span class="go">LOAD           0x001000 0x00010000 0x00010000 0x0004c 0x0004c R E 0x1000</span>

<span class="go">Section to Segment mapping:</span>
<span class="go">Segment Sections...</span>
<span class="go">00     .text .eh_frame</span>

<span class="go">There is no dynamic section in this file.</span>

<span class="go">There are no relocations in this file.</span>

<span class="go">The decoding of unwind sections for machine type Intel 80386 is not currently supported.</span>

<span class="go">Symbol table &#39;.symtab&#39; contains 9 entries:</span>
<span class="go">Num:    Value  Size Type    Bind   Vis      Ndx Name</span>
<span class="go">0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span>
<span class="go">1: 00010000     0 SECTION LOCAL  DEFAULT    1</span>
<span class="go">2: 00010014     0 SECTION LOCAL  DEFAULT    2</span>
<span class="go">3: 00000000     0 SECTION LOCAL  DEFAULT    3</span>
<span class="go">4: 00000000     0 FILE    LOCAL  DEFAULT  ABS start.o</span>
<span class="go">5: 00010008     0 NOTYPE  LOCAL  DEFAULT    1 loop</span>
<span class="go">6: 00000000     0 FILE    LOCAL  DEFAULT  ABS main.cpp</span>
<span class="go">7: 00010000    10 FUNC    GLOBAL DEFAULT    1 _start</span>
<span class="go">8: 0001000a    10 FUNC    GLOBAL DEFAULT    1 main</span>

<span class="go">No version information found in this file.</span>
</pre></div>
</td></tr></table></div>
<p>In the output of readelf we see that the entry point is at 0x10000, we see that
the .text section is located at the same address, and in the symbol table we
see all the symbols of our program. However, we dont see the .data and .bss
sections. Well, we do not have any variables, so these sections have been
dropped. So lets recompile with debug information and lets go through GDB</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> i686-elf-as -g start.S -o start.o
<span class="gp">#</span> i686-elf-g++ -g -c -o main.o main.cpp
<span class="gp">#</span> i686-elf-g++ -g -T i686.ld -o a.out -ffreestanding -nostdlib start.o main.o
<span class="gp">#</span> gdb ./a.out
<span class="go">Reading symbols from ./a.out...done.</span>
<span class="go">   (gdb) b _start</span>
<span class="go">Breakpoint 1 at 0x10000: file start.S, line 5.</span>
<span class="go">   (gdb) run</span>
<span class="go">Starting program: a.out</span>

<span class="go">   Breakpoint 1, _start () at start.S:5</span>
<span class="go">5               andl $0xfffffff0, %esp</span>
<span class="go">   (gdb) s</span>
<span class="go">6               call main</span>
<span class="go">   (gdb) s</span>
<span class="go">main () at main.cpp:6</span>
<span class="go">   6               return 0;</span>
<span class="go">(gdb) s</span>
<span class="go">   7       }</span>
<span class="go">(gdb) s</span>
<span class="go">   _start () at start.S:12</span>
<span class="go">12              jmp _start</span>
<span class="go">   (gdb) s</span>

<span class="go">Breakpoint 1, _start () at start.S:5</span>
<span class="go">   5               andl $0xfffffff0, %esp</span>
<span class="go">   (gdb) q</span>
</pre></div>
</td></tr></table></div>
<p>We set a breakpoint at the _start function, and we ran the program. The program
calls the main function, returns from it, and resumes execution at the _start
again.</p>
</div>
</div>
<span id="document-Boot"></span><div class="section" id="boot-process">
<h2>Boot Process<a class="headerlink" href="#boot-process" title="Permalink to this headline">¶</a></h2>
<div class="section" id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h3>
<p>According to the
<a class="reference external" href="http://www.intel.co.uk/content/www/uk/en/architecture-and-technology/64-ia-32-architectures-software-developer-manual-325462.html">Intel Software Developer’s Manual</a>
the first instruction that is fetched and executed following a hardware reset is
located at physical address FFFFFFF0H. At this point conrol is passed to the
BIOS which runs diagnostic tests and configures the devices of the system. At
the very end BIOS passes control to the boot loader. When the BIOS supports
<a class="reference external" href="http://www.uefi.org/">EFI</a>, it loads EFI applications from the EFI System
Partition. If the BIOS is legacy, it loads the boot loader from the Master Boot
Record (MBR).</p>
</div>
<div class="section" id="grub-multiboot">
<h3>GRUB - Multiboot<a class="headerlink" href="#grub-multiboot" title="Permalink to this headline">¶</a></h3>
<p>The boot loader that we will be using is <a class="reference external" href="http://www.gnu.org/software/grub/">GRUB 2</a>.
GRUB is modular, it is shipped with a large set of modules and it can be easily
extended further. It supports both legacy and EFI capable BIOS. GRUB 2 has three
interfaces for loading a kernel or a second boot loader, namely chainloader,
linux and multiboot.</p>
<div class="section" id="chainloading">
<h4>Chainloading<a class="headerlink" href="#chainloading" title="Permalink to this headline">¶</a></h4>
<p>Chainloading is the method of loading a second boot loader. When GRUB is
loaded by a legacy BIOS from the MBR, it expects that the second boot
loader will be loaded in the same fashion. As such it expects that the
chainloader command will be passed a series of blocks that correspond to the
second boot loader (see the
<a class="reference external" href="https://www.gnu.org/software/grub/manual/html_node/Block-list-syntax.html#Block-list-syntax">block list syntaxt</a>).
For more information please see the source of the
<a class="reference external" href="http://git.savannah.gnu.org/cgit/grub.git/tree/grub-core/loader/i386/pc/chainloader.c">lecacy loader</a>.</p>
<p>When GRUB is loaded from an EFI capable BIOS, it expects that the second
boot loader will also be an EFI application. As such it expects that the
chainloader command will be given a file name of an EFI application to load.
For more information please see the source of the
<a class="reference external" href="http://git.savannah.gnu.org/cgit/grub.git/tree/grub-core/loader/efi/chainloader.c">EFI loader</a>.</p>
</div>
<div class="section" id="linux">
<h4>Linux<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h4>
<p>This is the method of loading a Linux kernel. The first argument to the linux
command is the kernel to load, and any subsequent arguments are passed as
arguments to the kernel. The command adheres to the version 2.10 of the Linux
<a class="reference external" href="https://github.com/torvalds/linux/blob/master/Documentation/x86/boot.txt">boot protocol</a>.
The Linux boot protocol describes the memory layout for BIOS, loader and the
kernel. It also describes the header that is used to communicate information
between the kernel and the loader.</p>
</div>
<div class="section" id="multiboot">
<h4>Multiboot<a class="headerlink" href="#multiboot" title="Permalink to this headline">¶</a></h4>
<p>Multiboot is the method of loading a kernel that adheres to the Multiboot
<a class="reference external" href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">version 1</a> or
<a class="reference external" href="http://download-mirror.savannah.gnu.org/releases/grub/phcoder/multiboot.pdf">version 2</a>
specifications. For example lets take a minimal kernel program. The _start
function calls main:</p>
<div class="highlight-gas"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="na">.section</span> <span class="no">.text</span>
<span class="na">.global</span> <span class="no">_start</span>
<span class="na">.type</span> <span class="no">_start</span><span class="p">,</span> <span class="na">@function</span>
<span class="nl">_start:</span>
   <span class="nf">andl</span> <span class="no">$0xfffffff0</span><span class="p">,</span> <span class="nv">%esp</span>
   <span class="nf">call</span> <span class="no">main</span>
<span class="nl">loop:</span>
   <span class="nf">hlt</span>
   <span class="nf">jmp</span> <span class="no">loop</span>
<span class="na">.size</span> <span class="no">_start</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_start</span>
</pre></div>
</td></tr></table></div>
<p>The main program just returns 0xDEADBEEF:</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#if defined(__cplusplus)</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span>
<span class="cp">#endif</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="mh">0xDEADBEEF</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The linker script puts the pieces together:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre>ENTRY(_start)

SECTIONS
{
   . = 1M;
   .text :
   {
      *(.text)
      . = ALIGN(8K);
   }
   .data :
   {
      *(.data)
      . = ALIGN(8K);
   }
   .bss :
   {
      *(.bss)
      . = ALIGN(8K);
   }
   .comment :
   {
      *(.comment)
   }
}
</pre></div>
</td></tr></table></div>
<p>When we boot this kernel we see that GRUB complains about not beeing able to
find the Multiboot header.</p>
<img alt="_images/multiboot.png" src="_images/multiboot.png" />
<p>Multiboot compliant kernels contain a Multiboot header which
should appear within the first 32768 bytes of the executable. The following
example introduces a .multiboot section, which is split in two subsections. The
first holds the header for the Multiboot 1 specification, and the second
holds the header for the Multiboot 2 specification:</p>
<div class="highlight-gas"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="na">.section</span> <span class="no">.multiboot</span>
<span class="na">.align</span> <span class="mi">8</span>
<span class="nl">mbAs:</span>
   <span class="na">.long</span> <span class="mi">0x1BADB002</span>            <span class="c"># MAGIC</span>
   <span class="na">.long</span> <span class="mi">0x1</span>                   <span class="c"># FLAGS</span>
   <span class="na">.long</span> <span class="mi">0</span> <span class="p">-</span> <span class="mi">0x1BADB002</span> <span class="p">-</span> <span class="mi">0x1</span>  <span class="c"># CHECKSUM</span>
<span class="nl">mbAe:</span>
<span class="na">.align</span> <span class="mi">8</span>
<span class="nl">mbBs:</span>
   <span class="na">.long</span> <span class="mi">0xE85250D6</span>                          <span class="c"># MAGIC</span>
   <span class="na">.long</span> <span class="mi">0</span>                                   <span class="c"># ARCHITECTURE</span>
   <span class="na">.long</span> <span class="no">mbBe</span> <span class="p">-</span> <span class="no">mbBs</span>                         <span class="c"># HEADER LENGTH</span>
   <span class="na">.long</span> <span class="mi">0</span> <span class="p">-</span> <span class="mi">0xE85250D6</span> <span class="p">-</span> <span class="mi">0</span> <span class="p">-</span> <span class="p">(</span><span class="no">mbBe</span> <span class="p">-</span> <span class="no">mbBs</span><span class="p">)</span>  <span class="c"># CHECKSUM</span>
   <span class="na">.short</span> <span class="mi">0</span>                                  <span class="c"># END TAG</span>
   <span class="na">.short</span> <span class="mi">0</span>                                  <span class="c"># TAG FLAG</span>
   <span class="na">.long</span> <span class="mi">8</span>                                   <span class="c"># TAG SIZE</span>
<span class="nl">mbBe:</span>
<span class="na">.section</span> <span class="no">.text</span>
<span class="na">.global</span> <span class="no">_start</span>
<span class="na">.type</span> <span class="no">_start</span><span class="p">,</span> <span class="na">@function</span>
<span class="nl">_start:</span>
   <span class="nf">andl</span> <span class="no">$0xfffffff0</span><span class="p">,</span> <span class="nv">%esp</span>
   <span class="nf">call</span> <span class="no">main</span>
<span class="nl">loop:</span>
   <span class="nf">hlt</span>
   <span class="nf">jmp</span> <span class="no">loop</span>
<span class="na">.size</span> <span class="no">_start</span><span class="p">,</span> <span class="p">.</span> <span class="p">-</span> <span class="no">_start</span>
</pre></div>
</td></tr></table></div>
<p>We need to modify our linker script so that the .multiboot section appears at
the beginning of the executable:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre>ENTRY(_start)

SECTIONS
{
   . = 1M;
   .multiboot :
   {
      *(.multiboot)
      . = ALIGN(8K);
   }
   .text :
   {
      *(.text)
      . = ALIGN(8K);
   }
   .data :
   {
      *(.data)
      . = ALIGN(8K);
   }
   .bss :
   {
      *(.bss)
      . = ALIGN(8K);
   }
   .comment :
   {
      *(.comment)
   }
}
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<span id="document-KernelModule"></span><div class="section" id="kernel-modules">
<h2>Kernel Modules<a class="headerlink" href="#kernel-modules" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>A good starting point for module development is
<a class="reference external" href="https://lwn.net/Kernel/LDD3/">Linux Device Drivers, Third Edition</a>. As an
example we will add the following module to the kernel source tree:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> find ./drivers/os/
<span class="go">./drivers/os/</span>
<span class="go">./drivers/os/Kconfig</span>
<span class="go">./drivers/os/modapi.c</span>
<span class="go">./drivers/os/Makefile</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="modapi-c">
<h3>modapi.c<a class="headerlink" href="#modapi-c" title="Permalink to this headline">¶</a></h3>
<p>The file modapi.c holds the source code of the module:</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2016 Dionysios Kalofonos</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;         </span><span class="c1">// __init, __exit, module_init, and module_exit</span>
<span class="cp">#include &lt;linux/kernel.h&gt;       </span><span class="c1">// several utilities, includes printk</span>
<span class="cp">#include &lt;linux/module.h&gt;       </span><span class="c1">// MODULE_LICENSE, MODULE_AUTHOR, MODULE_DESCRIPTION</span>
<span class="cp">#include &lt;linux/export.h&gt;       </span><span class="c1">// THIS_MODULE</span>

<span class="c1">// module information</span>
<span class="cp">#define MODULE_NAME &quot;modapi&quot;</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dionysios Kalofonos&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Poke the Module API&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Callback for module loading. __init is an attribute meaning that the</span>
<span class="cm"> * memory used by this function can be thrown away after initialisation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">MODULE_NAME</span> <span class="s">&quot;: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Callback for module unloading. __exit is an attribute meaning that the</span>
<span class="cm"> * function can be ignored when compiling for statically linking.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mod_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">MODULE_NAME</span> <span class="s">&quot;: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// export module functions</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">mod_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mod_exit</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="kconfig-and-makefile">
<h3>Kconfig and Makefile<a class="headerlink" href="#kconfig-and-makefile" title="Permalink to this headline">¶</a></h3>
<p>With this module we are adding to the drivers directory the sub-directory named
&#8220;os&#8221;, and the module modapi.c. In order for the new directory to be considered
during building, we need to append an obj target to the Makefile of the
parent directory:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> tail drivers/Makefile
<span class="go">obj-$(CONFIG_IPACK_BUS)         += ipack/</span>
<span class="go">obj-$(CONFIG_NTB)               += ntb/</span>
<span class="go">obj-$(CONFIG_FMC)               += fmc/</span>
<span class="go">obj-$(CONFIG_POWERCAP)          += powercap/</span>
<span class="go">obj-$(CONFIG_MCB)               += mcb/</span>
<span class="go">obj-$(CONFIG_RAS)               += ras/</span>
<span class="go">obj-$(CONFIG_THUNDERBOLT)       += thunderbolt/</span>
<span class="go">obj-$(CONFIG_CORESIGHT)         += coresight/</span>
<span class="go">obj-$(CONFIG_ANDROID)           += android/</span>
<span class="go">obj-$(CONFIG_OS_MODAPI_C)       += os/</span>
</pre></div>
</td></tr></table></div>
<p>Within the directory &#8220;os&#8221; we need a makefile, which lists the files that we
need to build for the new obj target:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> cat drivers/os/Makefile
<span class="gp">#</span> MODAPI module

<span class="go">obj-$(CONFIG_OS_MODAPI_C)               += modapi.o</span>
</pre></div>
</td></tr></table></div>
<p>Equivalently, we need to setup the config files. In the Kconfig of the parent
directory we need to source the new Kconfig:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> tail drivers/Kconfig

<span class="go">source &quot;drivers/ras/Kconfig&quot;</span>

<span class="go">source &quot;drivers/thunderbolt/Kconfig&quot;</span>

<span class="go">source &quot;drivers/android/Kconfig&quot;</span>

<span class="go">source &quot;drivers/os/Kconfig&quot;</span>

<span class="go">endmenu</span>
</pre></div>
</td></tr></table></div>
<p>Within the &#8220;os&#8221; directory we introduce a new config file, which allows us to
set the value of the variable CONFIG_OS_MODAPI_C. Since we are introducing a
new directory, in our Kconfig we also add a menu entry:</p>
<div class="highlight-console"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="gp">#</span> cat drivers/os/Kconfig
<span class="go">menu &quot;Operating System&quot;</span>

<span class="go">config OS_MODAPI_C</span>
<span class="go">   tristate &quot;Poke the Module API&quot;</span>
<span class="go">   default n</span>
<span class="go">   help</span>
<span class="go">      A minimal module showcasing the module API.</span>
<span class="go">endmenu # &quot;Operating System&quot;</span>
</pre></div>
</td></tr></table></div>
<p>We set the type of the variable to tristate as this variable can be set to one
of &#8216;n&#8217; for not building the module, &#8216;M&#8217; for building the module for dynamic
loading, and &#8216;*&#8217; for statically linking the module.</p>
</div>
</div>
<span id="document-DescriptorTables"></span><div class="section" id="descriptor-tables">
<h2>Descriptor Tables<a class="headerlink" href="#descriptor-tables" title="Permalink to this headline">¶</a></h2>
<div class="section" id="global-descriptor-table">
<h3>Global Descriptor Table<a class="headerlink" href="#global-descriptor-table" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html#document-index">Table Of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Introduction">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Toolchain">Toolchain</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#building-a-cross-compiler">Building a cross-compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#building-grub">Building GRUB</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#building-linux">Building Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#building-linux-modules">Building Linux modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#debugging-with-a-vm">Debugging with a VM</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-ProgramLoading">Program loading</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#elf-executable-and-linking-format">ELF: Executable and Linking Format</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#program-linking-and-loading">Program linking and loading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-Boot">Boot Process</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#grub-multiboot">GRUB - Multiboot</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-KernelModule">Kernel Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#modapi-c">modapi.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#kconfig-and-makefile">Kconfig and Makefile</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-DescriptorTables">Descriptor Tables</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#global-descriptor-table">Global Descriptor Table</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html#document-index">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
      &copy;2016, Dionysios Kalofonos.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster </a>
      
    </div>

    
    <a href="https://github.com/ghdk/os" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>